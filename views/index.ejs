<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inicio - Passport Challenge</title>
</head>
<body>
  <h1>Bienvenido <%= username ? username : "invitado" %></h1>

  <% if (!username) { %>
    <h2>Iniciar sesión</h2>
    <form id="loginForm">
      <input type="text" id="loginUser" placeholder="Usuario" required>
      <input type="password" id="loginPass" placeholder="Contraseña" required>
      <button type="submit">Entrar</button>
    </form>

    <h2>Registrarse</h2>
    <form id="registerForm">
      <input type="text" id="regUser" placeholder="Usuario" required>
      <input type="password" id="regPass" placeholder="Contraseña" required>
      <button type="submit">Registrar</button>
    </form>
  <% } else { %>
    <p>Ya has iniciado sesión como <b><%= username %></b></p>
    <button id="protectedBtn">Ir a zona protegida</button>
    <button id="logoutBtn">Cerrar sesión</button>
  <% } %>

  <script>
    const csrfToken = '<%= csrfToken %>'; // Token CSRF desde el servidor

    // LOGIN
    document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const username = document.getElementById('loginUser').value
      const password = document.getElementById('loginPass').value

      const res = await fetch('/login', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'CSRF-Token': csrfToken
        },
        body: JSON.stringify({ username, password })
      })

      if (res.ok) {
        location.reload()
      } else {
        alert('Error en login')
      }
    })

    // REGISTRO
    document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
      e.preventDefault()
      const username = document.getElementById('regUser').value
      const password = document.getElementById('regPass').value

      const res = await fetch('/register', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'CSRF-Token': csrfToken
        },
        body: JSON.stringify({ username, password })
      })

      if (res.ok) {
        alert('Usuario creado, ahora puedes iniciar sesión')
      } else {
        alert('Error en registro')
      }
    })

    // LOGOUT
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      await fetch('/logout', { 
        method: 'POST',
        headers: { 'CSRF-Token': csrfToken }
      })
      location.reload()
    })

    // IR A ZONA PROTEGIDA
    document.getElementById('protectedBtn')?.addEventListener('click', () => {
      window.location.href = '/protected'
    })
  </script>
</body>
</html>
